# 08-1. 데이터 집계하기
### groupby() 메서드로 데이터 집계하기
1. 갭마인더 데이터셋을 활용한다
```
          country continent  year  lifeExp       pop   gdpPercap
0     Afghanistan      Asia  1952   28.801   8425333  779.445314
1     Afghanistan      Asia  1957   30.332   9240934  820.853030
2     Afghanistan      Asia  1962   31.997  10267083  853.100710
3     Afghanistan      Asia  1967   34.020  11537966  836.197138
4     Afghanistan      Asia  1972   36.088  13079460  739.981106
...           ...       ...   ...      ...       ...         ...
1699     Zimbabwe    Africa  1987   62.351   9216418  706.157306
1700     Zimbabwe    Africa  1992   60.377  10704340  693.420786
1701     Zimbabwe    Africa  1997   46.809  11404948  792.449960
1702     Zimbabwe    Africa  2002   39.989  11926563  672.038623
1703     Zimbabwe    Africa  2007   43.487  12311143  469.709298

[1704 rows x 6 columns]
```
2. groupby 메서드로 year열을 기준으로 데이터를 그룹화하고 mean 메서드로 lifeExp 열의 평균 구하기
```python
avg_life_exp_by_year = df.groupby('year')["lifeExp"].mean()
print(avg_life_exp_by_year)
```
📝 실행결과
```
year
1952    49.057620
1957    51.507401
1962    53.609249
1967    55.678290
1972    57.647386
1977    59.570157
1982    61.533197
1987    63.212613
1992    64.160338
1997    65.014676
2002    65.694923
2007    67.007423
Name: lifeExp, dtype: float64year
```

3. groupby() 메서드는 열의 고윳값 또는 여러 열을 조합한 고윳값의 하위 집합을 생성하는 역할을 한다.
```python
years = df.year.unique()
print(years)
```
📝 실행결과
```
[1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 2002 2007]
```

4. 고윳값별로 데이터의 하위 집합을 추출. year 열의 고윳값 하나를 골라 해당 연도의 데이터를 살펴본다.
```python
y=1952 = df.loc[df.year == 1952, :]
print(y1952)
```
📝 실행결과
```
                 country continent  year  lifeExp       pop    gdpPercap
0            Afghanistan      Asia  1952   28.801   8425333   779.445314
12               Albania    Europe  1952   55.230   1282697  1601.056136
24               Algeria    Africa  1952   43.077   9279525  2449.008185
36                Angola    Africa  1952   30.015   4232095  3520.610273
48             Argentina  Americas  1952   62.485  17876956  5911.315053
...                  ...       ...   ...      ...       ...          ...
1644             Vietnam      Asia  1952   40.412  26246839   605.066492
1656  West Bank and Gaza      Asia  1952   43.160   1030585  1515.592329
1668         Yemen, Rep.      Asia  1952   32.548   4963829   781.717576
1680              Zambia    Africa  1952   42.038   2672000  1147.388831
1692            Zimbabwe    Africa  1952   48.451   3080907   406.884115

[142 rows x 6 columns]
```

5. 추출한 하위 집합에도 메서드를 적용할 수 있다. lifeExp 열의 평균을 구해본다
```python
y1952_mean = y1952["lifeExp"].mean()
print(y1952_mean)
```
📝 실행결과
```
49.057619718309866
```

## groupby() 메서드와 함께 사용하는 집계 메서드
1. describe()를 사용하면 여러 요약 통게를 확인할 수 있다.
2. continent 열로 그룹화 하고 descibe() 메서드를 호출하면 대륙별 요약 통계를 확인할 수 있다.
```python
continent_describe = df.groupby('continent')["lifeExp"].descibe()
print(continent_descibe)
```
📝 실행결과
```
           count       mean        std     min       25%      50%       75%  \
continent                                                                     
Africa     624.0  48.865330   9.150210  23.599  42.37250  47.7920  54.41150   
Americas   300.0  64.658737   9.345088  37.579  58.41000  67.0480  71.69950   
Asia       396.0  60.064903  11.864532  28.801  51.42625  61.7915  69.50525   
Europe     360.0  71.903686   5.433178  43.585  69.57000  72.2410  75.45050   
Oceania     24.0  74.326208   3.795611  69.120  71.20500  73.6650  77.55250   

              max  
continent          
Africa     76.442  
Americas   80.653  
Asia       82.603  
Europe     81.757  
Oceania    81.235
```

## agg() 메서드와 groupby() 메서드 조합하기
### 다른 라이브러리의 집계 함수 사용하기
1. agg() 메서드에 넘파이의 mean() 함수를 전달하여 평균을 구할 수 있다.
```python
import numpy as np

cont_le_agg = df.groupby('continent')["lifeExp"].agg(np.mean)
print(cont_le_agg)
```
📝 실행결과
```
continent
Africa      48.865330
Americas    64.658737
Asia        60.064903
Europe      71.903686
Oceania     74.326208
Name: lifeExp, dtype: float64
```
### 사용자 집계함수 사용하기
* 라이브러리에서 제공하는 집계 메서드로는 원하는 값을 계산할 수 없다면 직접 함수를 만들어서 agg()에 전달하면 됨
1. 평균을 구하는 함수 직접 만들기
```python
def my_mean(values):
  n = len(values)
  sum = 0
  for value in values:
    sum += value
  return sum / n
```
2. agg()에 my_mean으로 전달하기
```python
agg_my_mean = df.groupby('year')["lifeExp"].agg(my_mean)
print(agg_my_mean)
```
📝 실행결과
```
year
1952    49.057620
1957    51.507401
1962    53.609249
1967    55.678290
1972    57.647386
1977    59.570157
1982    61.533197
1987    63.212613
1992    64.160338
1997    65.014676
2002    65.694923
2007    67.007423
Name: lifeExp, dtype: float64
```
3. 매개변수가 여러개인 사용자 함수 전달하기
* 사용자 함수의 첫 번째 매개변수가 데이터프레임의 시리즈여야 한다.
* 연도나 대륙과 상관없이 전체 기대 수명의 평균 diff_value와 각 그룹 평균 수명의 차이를 계산하는 my_mean_diff() 함수를 생성
```python
def my_mean_diff(values, diff_value):
  n = len(value)
  sum = 0
  for value in values:
    sum += values
  mean = sum / n
  return (mean-diff_value)
```
4. 모든 기대 수명의 평균
```python
global_mean = df["lifeExp"].mean()
print(global_mean)
```
📝 실행결과
```
59.474439366197174
```
5. my_mean_diff()함수를 agg() 메서드에 전달
```python
agg_mean_diff = (
  df
  .groupby("year")
  ["lifeExp"]
  .agg(my_mean_diff, diff_value = global_mean) # 첫 번째 매개변수는 함수 이름, 두 번째부터는 함수의 매개변수 이름과 함께 전달
)

print(agg_mean_diff)
```
📝 실행결과
```
year
1952   -10.416820
1957    -7.967038
1962    -5.865190
1967    -3.796150
1972    -1.827053
1977     0.095718
1982     2.058758
1987     3.738173
1992     4.685899
1997     5.540237
2002     6.220483
2007     7.532983
Name: lifeExp, dtype: float64
```
## 여러 개의 집계 함수 한 번에 사용하기
* 여러 개의 집계함수를 한 번에 사용하고 싶다면 집게 함수들을 리스트 형식으로 agg() 메서드에 전달
```python
gdf = (
  df
  .groupby("year")
  ["lifeExp"]
  .agg([np.count_nonzero, np.mean, np.std])
)

print(gdf)
```
📝 실행결과
```
      count_nonzero       mean        std
year                                     
1952            142  49.057620  12.225956
1957            142  51.507401  12.231286
1962            142  53.609249  12.097245
1967            142  55.678290  11.718858
1972            142  57.647386  11.381953
1977            142  59.570157  11.227229
1982            142  61.533197  10.770618
1987            142  63.212613  10.556285
1992            142  64.160338  11.227380
1997            142  65.014676  11.559439
2002            142  65.694923  12.279823
2007            142  67.007423  12.073021
```
### agg() 메서드에 딕셔너리 사용하기
1. 데이터프레임에 사용하기
* 데이터프레임의 열을 key로, 집계 함수를 value로 설정
* 하나 이상의 변수를 그룹화하고 열별로 서로 다른 집계 함수를 적용할 수 있다
```python
gdf_dict = df.groupby("year").agg(
  {
    "lifeExp" : "mean",
    "pop" : "median",
    "gdpPercap" : "median"
  }
)

print(gdf_dict)
```
📝 실행결과
```
        lifeExp         pop    gdpPercap
year                                    
1952  49.057620   3943953.0  1968.528344
1957  51.507401   4282942.0  2173.220291
1962  53.609249   4686039.5  2335.439533
1967  55.678290   5170175.5  2678.334740
1972  57.647386   5877996.5  3339.129407
1977  59.570157   6404036.5  3798.609244
1982  61.533197   7007320.0  4216.228428
1987  63.212613   7774861.5  4280.300366
1992  64.160338   8688686.5  4386.085502
1997  65.014676   9735063.5  4781.825478
2002  65.694923  10372918.5  5319.804524
2007  67.007423  10517531.0  6124.371108
```

2. 시리즈에 사용하기
* 원하는 함수 목록을 agg()에 전달하고나서 rename() 메서드로 결과 열의 이름을 변경
```python
gdf = (
    df
    .groupby("year")
    ["lifeExp"]
    .agg(
        [
            np.count_nonzero,
            np.mean,
            np.std
        ]
    )
    .rename(
        columns={
              "count_nonzero" : "count"
              "mean" : avg"
              "std" : "std_dev"
            }
      )
      .reset_index()
)

print(gdf)
```
📝 실행결과
```
    year  count        avg    std_dev
0   1952    142  49.057620  12.225956
1   1957    142  51.507401  12.231286
2   1962    142  53.609249  12.097245
3   1967    142  55.678290  11.718858
4   1972    142  57.647386  11.381953
5   1977    142  59.570157  11.227229
6   1982    142  61.533197  10.770618
7   1987    142  63.212613  10.556285
8   1992    142  64.160338  11.227380
9   1997    142  65.014676  11.559439
10  2002    142  65.694923  12.279823
11  2007    142  67.007423  12.073021
```
